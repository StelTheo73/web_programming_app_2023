"use strict";import{showItemsInCart as e,clearCart as t}from"./cart.min.mjs";import{removeTones as r}from"./greekRegex.min.mjs";let ORDER_OVERLAY=document.querySelector("#order-overlay-container"),SHOP_ADDRESS_SPAN=document.querySelector(".shop-items-container > div > div > span"),EMPTY_ORDER_FEEDBACK=ORDER_OVERLAY.querySelector("#empty-order-feedback"),NO_ADDRESS_FEEDBACK=ORDER_OVERLAY.querySelector("#no-address-feedback"),ORDER_FORM=ORDER_OVERLAY.querySelector("form"),SHOP_ID_INPUT=ORDER_FORM.querySelector("#order-shop-id"),ORDER_ITEMS_INPUT=ORDER_FORM.querySelector("#order-items"),ADDRESS_SELECT=ORDER_FORM.querySelector("#order-address"),PHONE_INPUT=ORDER_FORM.querySelector("#order-phone"),PAYMENT_MEAN_SELECT=ORDER_FORM.querySelector("form #order-payment-mean"),CARD_SELECT=ORDER_FORM.querySelector("form #order-card"),NOTES_INPUT=ORDER_FORM.querySelector("form #order-notes"),SUBMIT_BUTTON=ORDER_FORM.querySelector("#order-submit-button"),RETURN_BUTTON=ORDER_FORM.querySelector("#order-return-button");function orderButtonListener(){RETURN_BUTTON.addEventListener("click",function(t){t.preventDefault(),ORDER_OVERLAY.classList.remove("show"),e()}),PAYMENT_MEAN_SELECT.addEventListener("change",function(e){"CARD"===e.target.value?(CARD_SELECT.parentElement.classList.remove("hidden"),CARD_SELECT.removeAttribute("disabled")):(CARD_SELECT.parentElement.classList.add("hidden"),CARD_SELECT.setAttribute("disabled",!0))}),ORDER_FORM.addEventListener("submit",function(e){validateOrder(e)})}async function fillFormWithUserData(){let e=await fetchUserItems(),t=e.phone,d=e.addresses,E=e.cards,i=!1;if(null==d||0===d.length)ORDER_FORM.classList.add("hidden"),NO_ADDRESS_FEEDBACK.classList.remove("hidden");else for(let s of d){let o=document.createElement("option");if(r(s.city.toLowerCase())!==r(SHOP_ADDRESS_SPAN.innerHTML.toLowerCase()))continue;i=!0;let R=`${s.city}, ${s.street} ${s.number}, ${s.floor}, ${s.bell}`;R.length>50&&(R=R.slice(0,50)+"...");let a=document.createTextNode(R);o.setAttribute("value",s.address_id),o.appendChild(a),ADDRESS_SELECT.appendChild(o)}if(!1===i&&ADDRESS_SELECT.querySelector("option").classList.remove("hidden"),null==E||0===E.length)CARD_SELECT.querySelector("option").classList.remove("hidden");else for(let l of(CARD_SELECT.querySelector("option").classList.add("hidden"),E)){let n=document.createElement("option"),c=document.createTextNode(l.cardNumber);n.setAttribute("value",l._id),n.appendChild(c),CARD_SELECT.appendChild(n)}PHONE_INPUT.value=t}async function fetchUserItems(){let e=[];return await fetch("/fetch/user-items",{method:"POST",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(t=>{e=t}).catch(e=>{console.log(e)}),e}function showEmptyOrder(){ORDER_FORM.classList.add("hidden"),EMPTY_ORDER_FEEDBACK.classList.remove("hidden"),SUBMIT_BUTTON.setAttribute("disabled",!0)}function showOrder(){let e=window.location.href.split("/")[4],t=sessionStorage.getItem(e);if(ORDER_OVERLAY.classList.add("show"),null==t||0===t.length){showEmptyOrder();return}SUBMIT_BUTTON.removeAttribute("disabled"),ORDER_FORM.classList.remove("hidden"),EMPTY_ORDER_FEEDBACK.classList.add("hidden"),NO_ADDRESS_FEEDBACK.classList.add("hidden"),SHOP_ID_INPUT.value=e,ORDER_ITEMS_INPUT.value=t,fillFormWithUserData()}function validateOrder(e){if(!1===ADDRESS_SELECT.checkValidity()||!1===PHONE_INPUT.checkValidity()||!1===PAYMENT_MEAN_SELECT.checkValidity||"CARD"===PAYMENT_MEAN_SELECT.value&&!1===CARD_SELECT.checkValidity()){e.preventDefault(),ORDER_FORM.classList.add("was-validated");return}SHOP_ID_INPUT.removeAttribute("disabled"),ORDER_ITEMS_INPUT.removeAttribute("disabled"),ORDER_FORM.classList.add("was-validated"),t()}export{showOrder,orderButtonListener};